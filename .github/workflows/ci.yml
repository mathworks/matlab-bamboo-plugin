name: build-plugin

on:
  push:
  workflow_dispatch:
jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: corretto
          java-version: 21
          cache: maven
      - name: setup Atlassian SDK
        run: |
          sudo sh -c 'echo "deb https://packages.atlassian.com/debian/atlassian-sdk-deb/ stable contrib" >> /etc/apt/sources.list'
          curl -fL https://packages.atlassian.com/api/gpg/key/public -o public
          sudo apt-key add public
          sudo apt-get update
          sudo apt-get install atlassian-plugin-sdk=8.2.8
          atlas-version
      - name: Install dependencies
        run: atlas-mvn install -q
      - name: Unit test
        run: atlas-unit-test
      - name: Package plugin
        run: atlas-package
      - name: Upload plugin as artifact
        uses: actions/upload-artifact@v4
        with:
          name: matlab-bamboo-plugin
          path: target/matlab-bamboo-plugin-*-SNAPSHOT.jar

  deploy:
    runs-on: self-hosted
    needs: build-and-test

    steps:
      - name: Download Plugin Artifact
        uses: actions/download-artifact@v4
        with:
          path: C:\CI\Bamboo-home\shared\plugins

      - name: Move plugin to correct location
        run: |
          Move-Item -Path "C:\CI\Bamboo-home\shared\plugins\matlab-bamboo-plugin\*.jar" -Destination "C:\CI\Bamboo-home\shared\plugins\" -Force
          Remove-Item -Path "C:\CI\Bamboo-home\shared\plugins\matlab-bamboo-plugin" -Recurse

      - name: Restart Bamboo Server
        run: |
          # PowerShell script to stop and start the Bamboo service with status checks
          $serviceName = "Bamboo"
          $maxWaitTime = 60
          $waitTime = 0

          Stop-Service -Name $serviceName -Force

          while ((Get-Service -Name $serviceName).Status -ne 'Stopped' -and $waitTime -lt $maxWaitTime) {
              Start-Sleep -Seconds 10
              $waitTime += 10
          }

          if ((Get-Service -Name $serviceName).Status -eq 'Stopped') {
              Start-Service -Name $serviceName
              Write-Host "Starting Bamboo service..."

              $waitTime = 0

              while ((Get-Service -Name $serviceName).Status -ne 'Running' -and $waitTime -lt $300) {
                  Start-Sleep -Seconds 20
                  $waitTime += 20
              }

              if ((Get-Service -Name $serviceName).Status -eq 'Running') {
                  Write-Host "Bamboo service started successfully."
              } else {
                  Write-Host "Failed to start the Bamboo service within the allotted time."
                  exit 1
              }
          } else {
              Write-Host "Failed to stop the Bamboo service within the allotted time."
              exit 1
          }
        shell: powershell
        
      - name: Trigger and Validate Bamboo Pipeline
        run: |
          python src/test/system/test1.py
